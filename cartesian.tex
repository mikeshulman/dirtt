\documentclass[11pt]{article}
\usepackage{times}

\usepackage{fullpage}
\usepackage{ifthen}
\usepackage{latexsym,amsmath,amsfonts,amssymb,stmaryrd,amsthm}
\usepackage{verbatim,fancyvrb}
\usepackage{multicol}
\usepackage{proof}
\usepackage[square]{natbib}

\usepackage{ucs}
\usepackage[utf8x]{inputenc}
\usepackage[T1]{fontenc}

\input{drl-macros}

\DefineVerbatimEnvironment{code}{Verbatim}{fontsize=\small,fontfamily=tt}

\theoremstyle{plain}
\newtheorem{thm}{Theorem}[section]
\newtheorem{lem}{Lemma}[section]

\title{All's Well That Ends Well}
\author{Daniel R. Licata \and Andreas Nuyts \and Patrick Schultz \and Michael Shulman}

\begin{document}
\maketitle

\section{Judgements}

\begin{itemize}

\item \wfdtp{\C} means \C\/ is a category; note that categories cannot
  depend on the context at all.  

\item \wfctx{\G} means $\Gamma$ is a category

\item \ofdtp{\G}{c}{\C} means $c$ is a functor
  ${\G} \to \C$

\item \wftp{\G}{T} means $T$ is a functor
  $\withop{\G} \to \Set$

\item \oftp{\G}{t}{T} means (descibe context extension; it's a
  section), equivalently an end.  

\end{itemize}

\section{Contexts and Structural Rules}

\[
\begin{array}{l}
v ::= \co \mid \con
w ::= \coc \mid \conc
\end{array}
\]

\[
\begin{array}{c}
\infer{\wfctx{\cdot}}{} 
\qquad
\infer{\wfctx{(\Gamma,\vtptm{x}{v}{\C})}}
      {\wfctx{\Gamma} & 
       \wfdtp{\C}
      } 
\qquad
\infer{\wfctx{(\Gamma,\tptmv{x}{w}{T})}}
      {\wfctx{\Gamma} & 
        \wftp{\Gamma^w}{T}
      } 
\end{array}
\]

\[
\begin{array}{rcl}
\Gamma^\co & := & \Gamma \\
\cdot^\con & := & \cdot \\
({\Gamma},\vtptm{x}{v}{\C})^\con & := & {\Gamma^\con},\vtptm{x}{\flip{v}}{A} \\
({\Gamma},\tptmv{x}{w}{T})^\con & := & {\Gamma^\con},\tptmv{x}{\flip{w}}{T} \\
\end{array}
\]
$\Gamma^w$ is defined in exactly the same way; the only reason we
differentiate the $v$/$w$ notation is for readability.  

\[
\infer{\ofdtp{\Gamma,\vtptm{x}{\co}{\C},\Gamma'}{x}{\C}}{}
\qquad
\infer{\oftp{\Gamma,\tptmv{x}{\coc}{T},\Gamma'}{x}{T}}{}
\]

\[
\infer[\textbf{admiss}]
      {\Gamma,\subst{\Gamma'}{c}{x} \vdash \subst{J}{c}{x}}
      {\Gamma,\vtptm{x}{v}{\C},\Gamma' \vdash {J} &
        \oftp{\Gamma^v}{c}{\C}}
\qquad
\infer[\textbf{admiss}]
      {\Gamma,\subst{\Gamma'}{t}{x} \vdash \subst{J}{t}{x}}
      {\Gamma,\tptmv{x}{w}{T},\Gamma' \vdash {J} &
        \oftp{\Gamma^w}{t}{T}}
\]

\section{Types}

\subsection{Universe}

The universe of sets is a directed type (e.g. the category of sets and
functions).

\[
\infer{\wfdtp{\types}}{}
\]

\FIXME{function determines a path?}

\subsection{Op Types}

\[
\begin{array}{c}
\infer{\wfdtp{\optp{\C}}}
      {\wfdtp{\C}}
\qquad
\infer{\ofdtp{\Gamma}{\optm{c}}{\optp{\C}}}
      {\ofdtp{\Gamma^\con}{c}{\C}}
\qquad
\infer{\ofdtp{\Gamma}{\unop{c}}{{\C}}}
      {\ofdtp{\Gamma^\con}{c}{\optm{\C}}}
\\ \\
\unop{\optm{c}} \deq c \\
\optm{\unop{c}} \deq c
\end{array}
\]

\subsection{Directed Types: Functions and Products}

Directed types have simple functions and products (exponentials and
products in \Cat).

\[
\begin{array}{c}
\infer{\wfdtp{\arr{\C_1}{\C_2}}}
      {\wfdtp{\C_1} &
        \wfdtp{\C_2}}
\qquad
\infer{\ofdtp{\Gamma}{\lam{x}{\C_1}{c}}{\arr {\C_1} {\C_2}}}
      {\ofdtp{\Gamma,\vptptm{x}{\co}{\C_1}}{c}{\C_2}}
\qquad
\infer{\ofdtp{\Gamma}{\app c {c'}}{\C_2}}
      {\ofdtp{\Gamma}{c}{\arr{\C_1}{\C_2}} &
        \ofdtp{\Gamma}{c'}{\C_1}}
\end{array}
\]

\[
\begin{array}{rcll}
\app {(\lam{x}{\C_1}{c})}{c'} & \equiv & \subst{c}{c'}{x} \\
\tptm{c}{\arr{\C_1}{\C_2}} & \equiv & {(\lam{x}{\C_1}{c}{x})} &
\end{array} \\
\]

\[
\begin{array}{c}
\infer{\wfdtp{\prd{\C_1}{\C_2}}}
      {\wfdtp{\C_1} &
        \wfdtp{\C_2}}
\qquad
\infer{\ofdtp{\Gamma}{\pair{c_1}{c_2}}{\prd {\C_1} {\C_2}}}
      {\ofdtp{\Gamma}{c_1}{\C_1} &
       \ofdtp{\Gamma}{c_2}{\C_2}}
\\ \\
\infer{\ofdtp{\Gamma}{\fst c}{\C_1}}
      {\ofdtp{\Gamma}{c}{\prd{\C_1}{\C_2}}}
\qquad
\infer{\ofdtp{\Gamma}{\snd c}{\C_2}}
      {\ofdtp{\Gamma}{c}{\prd{\C_1}{\C_2}}}
\end{array}
\]

\[
\begin{array}{rcll}
\fst{\pair{c_1}{c_2}} & \deq & c_1 \\
\snd{\pair{c_1}{c_2}} & \deq & c_1 \\
\tptm{c}{\prd{\C_1}{\C_2}} & \deq & \pair{\fst c}{\snd c}
\end{array}
\]

\subsection{Directed Types: Dependent types with families of sets}

Directed types also have dependent types where the dependent part is a
family of sets.  

\[
\begin{array}{c}
\infer{\wfdtp{\picl{x}{\C}{T}}}
      {\wfdtp{\C} &
       \wftp{\vptptm{x}{\co}{\C}}{T}}
\qquad
\infer{\ofdtp{\Gamma}{\lam{x}{\C}{t}}{\picl x \C T}}
      {\oftp{\Gamma,\vtptm{x}{\co}{\C}}{t}{T}}
\qquad
\infer{\oftpsf{\Delta}{\Gamma}{\app c {c'}}{\subst T {c'} x}}
      {\oftpc{\Delta}{\Gamma}{c}{\picl{x}{\C}{T}} &
        \oftpsf{\Delta}{\Gamma}{c'}{\C}}
\end{array}
\]

\[
\begin{array}{rcll}
\app {(\lam{x}{\C}{t})}{c} & \equiv & \subst{t}{c}{x} \\
\tptm{M}{\picl{x}{\C}{S}} & \equiv & {(\lam{x}{\C}{M}{x})} &
\end{array} \\
\]

\[
\begin{array}{c}
\infer{\wfdtp{\sigmacl{x}{\C}{T}}}
      {\wfdtp{\C} &
        \wfdtp{\vtptm{x}{\co}{\C}}{T}}
\qquad
\infer{\ofdtp{\Gamma}{\pair{c}{t}}{\sigmacl x \C T}}
      {\ofdtp{\Gamma}{c}{\C} &
       \ofdtp{\Gamma}{t}{\subst{T}{c}{x}}}
\\ \\
\infer{\ofdtp{\Gamma}{\fst c}{\C}}
      {\ofdtp{\Gamma}{c}{\sigmacl{x}{\C}{T}}}
\qquad
\infer{\ofdtp{\Gamma}{\snd c}{\subst{T}{\fst c}{x}}}
      {\ofdtp{\Gamma}{c}{\sigmacl{x}{\C}{T}}}
\end{array}
\]

\[
\begin{array}{rcll}
\fst{\pair{c}{t}} & \deq & c \\
\snd{\pair{c}{t}} & \deq & t \\
\tptm{c}{\sigmacl{x}{\C}{S}} & \deq & \pair{\fst c}{\snd c}
\end{array}
\]

%% FIXME not updated below here.  

\subsection{$\Pi$ sets}

\[
\begin{array}{c}
\infer{\wftpsf{\Delta}{\Gamma}{\picl{x}{S}{T}}}
      {\wftpsf{\Delta}{\Gamma^\con}{S} &
        \wftpsf{\Delta}{\Gamma, \vstptm {x}{\con}{S}}{T}}
\\ \\
\infer{\oftpsf{\Delta}{\Gamma}{\lam{x}{S}{M}}{\picl x S T}}
      {\oftpsf{\Delta}{\Gamma, \vstptm x {\con} S}{M}{T}}
\qquad
\infer{\oftpsf{\Delta}{\Gamma}{\app M N}{\subst T N x}}
      {\oftpsf{\Delta}{\Gamma}{M}{\picl{x}{S}{T}} &
        \oftpsf{\Delta}{\Gamma^\con}{N}{S}}
\end{array}
\]

\[
\begin{array}{rcll}
\app {(\lam{x}{S}{M})}{N} & \equiv & \subst{N}{x}{M} \\
\tptm{M}{\picl{x}{S}{T}} & \equiv & {(\lam{x}{S}{M}{x})} &
\end{array} \\
\]

\subsection{$\Sigma$ sets}

\[
\begin{array}{c}
\infer{\wftpsf{\Delta}{\Gamma}{\sigmacl{x}{S}{T}}}
      {\wftpsf{\Delta}{\Gamma}{S} &
        \wftpsf{\Delta}{\Gamma, \vstptm{x}{\co}{S}}{T}}
\qquad
\infer{\oftpsf{\Delta}{\Gamma}{\pair{M}{N}}{\sigmacl x S T}}
      {\oftpsf{\Delta}{\Gamma}{M}{S} &
       \oftpsf{\Delta}{\Gamma}{N}{\subst{T}{M}x}}
\\ \\
\infer{\oftpsf{\Delta}{\Gamma}{\fst M}{S}}
      {\oftpsf{\Delta}{\Gamma}{M}{\sigmacl{x}{S}{T}}}
\qquad
\infer{\oftpsf{\Delta}{\Gamma}{\snd M}{\subst{T}{\fst M}{x}}}
      {\oftpsf{\Delta}{\Gamma}{M}{\sigmacl{x}{S}{T}}}
\end{array}
\]

\[
\begin{array}{rcll}
\fst{\pair{M}{N}} & \deq & M \\
\snd{\pair{M}{N}} & \deq & N \\
\tptm{M}{\sigmacl{x}{S}{T}} & \deq & \pair{\fst M}{\snd M}
\end{array}
\]

\subsection{Bool}

\[
\begin{array}{c}
\infer{\wftpsf{\Delta}{\Gamma}{\dsd{2}}}
      {}
\qquad
\infer{\oftpsf{\Delta}{\Gamma}{\dsd{true}}{\dsd{2}}}{}
\qquad
\infer{\oftpsf{\Delta}{\Gamma}{\dsd{false}}{\dsd{2}}}{}
\\ \\
\infer{\oftpp{\Delta}{\Gamma}{\ite{\vstptm{x}{v}{\dsd{2}}.A}{N_1}{N_2}{M}}{\subst{A}{M}{x}}}
      {\wftpp{\Delta}{\Gamma,\vstptm{x}{v}{\dsd{2}}}{A} &
        \oftpsf{\Delta}{\Gamma^v}{M}{\dsd{2}} &
        \oftpp{\Delta}{\Gamma}{N_1}{\subst{A}{\dsd{true}}{x}} &
        \oftpp{\Delta}{\Gamma}{N_2}{\subst{A}{\dsd{false}}{x}}
      }
\\ \\
\begin{array}{rcll}
\ite{}{M_1}{M_2}{\dsd{true}} & \equiv & M_1 \\
\ite{}{M_1}{M_2}{\dsd{false}} & \equiv & M_2 \\
\end{array} \\
\end{array}
\]

\FIXME{what about dependency in $\Delta$?}


\subsection{Hom Sets (Axiomatic)}

\[
\begin{array}{c}
\infer{\wftpsf{\Delta}{\Gamma}{\Hom{\C}{M}{N}}}
      {\wftpcc{\Delta}{\C} &
        \oftpsf{\Delta}{\Gamma^\con}{M}{\C} & 
        \oftpsf{\Delta}{\Gamma}{N}{\C} 
      }
\\ \\
\infer{\oftpsf{\Delta}{\Gamma}{\refl{M}}{\Hom{\C}{\unob M}{\unob M}}}
      {\wftpcc{\Delta}{\C} &
        \oftpsf{\Delta}{\Gamma}{M}{\obtp{\C}}
      }
\\ \\
\infer{\oftpsf{\Delta}{\Gamma}{\morind{x_0,x_1,x.A}{M}{y.N}}{\subst{\subst{\subst{A}{M_0}{x_0}}{M_1}{x_1}}{M}{x}}}
      { \begin{array}{l}
          \wftpcc{\Delta}{\C} \\
          \wftpp{\Delta}{\Gamma,\vptptm{x_0}{\con}{\C},\vptptm{x_1}{\co}{\C},\vstptm{x}{\co}{\Hom{\C}{x_0}{x_1}}}{A} \\
          \oftpp{\Delta,\tptm{y}{\obtp{\C}}}{\Gamma}{N}{\subst{\subst{\subst{A}{\unob{y}}{x_0}}{\unob{y}}{x_1}}{\refl{y}}{x}} \\
          \oftpsf{\Delta}{\Gamma}{M}{\Hom{\C}{M_0}{M_1}} \\
        \end{array}
      }
\\ \\
\morind{}{\refl{M}}{y.N} \deq \subst{N}{M}{y}
\end{array}
\]


\[
\begin{array}{l}
\infer{\oftpsf{\Delta}{\Gamma}{\morindco{x_1,x.A}{M}{N}}{\subst{\subst{A}{M_1}{x_1}}{M}{x}}}
      { \begin{array}{l}
          \wftpcc{\Delta}{\C} \\
          \oftpp{\Delta}{\Gamma}{M_0}{\obtp \C} \\
          \wftpp{\Delta}{\Gamma,\vptptm{x_1}{\co}{\C},\vstptm{x}{\co}{\Hom{\C}{\unob{M_0}}{x_1}}}{A} \\
          \oftpp{\Delta}{\Gamma}{N}{\subst{\subst{A}{\unob{M_0}}{x_1}}{\refl{M_0}}{x}} \\
          \oftpsf{\Delta}{\Gamma}{M}{\Hom{\C}{\unob{M_0}}{M_1}} \\
        \end{array}
      }
\\ \\
\morindco{}{\refl{M_0}}{N} \deq N
\end{array}
\]

\[
\begin{array}{l}
\infer{\oftpsf{\Delta}{\Gamma}{\morindcon{x_0,x.A}{M}{N}}{\subst{\subst{A}{M_0}{x_0}}{M}{x}}}
      { \begin{array}{l}
          \wftpcc{\Delta}{\C} \\
          \oftpp{\Delta}{\Gamma}{M_1}{\obtp \C} \\
          \wftpp{\Delta}{\Gamma,\vptptm{x_0}{\con}{\C},\vstptm{x}{\co}{\Hom{\C}{x_0}{\unob{M_1}}}}{A} \\
          \oftpp{\Delta}{\Gamma}{N}{\subst{\subst{A}{\unob{M_1}}{x_0}}{\refl{M_1}}{x}} \\
          \oftpsf{\Delta}{\Gamma}{M}{\Hom{\C}{M_0}{\unob{M_1}}} \\
        \end{array}
      }
\\ \\
\morindcon{}{\refl{M_1}}{N} \deq N
\end{array}
\]

\subsection{Equality in Sets}

This could be done like ITT instead.  

\[
\begin{array}{c}
\infer{\wftpsf{\Delta}{\Gamma}{\Eq{S}{M}{N}}}
      {\wftpsf{\Delta}{\Gamma}{S} &
        \oftpsf{\Delta}{\Gamma}{M}{S} & 
        \oftpsf{\Delta}{\Gamma}{N}{S} 
      }
\qquad
\infer{\oftpsf{\Delta}{\Gamma}{\refl{M}}{\Eq{S}{M}{M}}}
      {\oftpsf{\Delta}{\Gamma}{M}{S}}
\\ \\
\infer{M \deq N}
      {\oftpsf{\Delta}{\Gamma}{P}{\Eq{S}{M}{N}}}
\qquad
\infer{P \deq \refl{M}}
      {\oftpsf{\Delta}{\Gamma}{P}{\Eq{S}{M}{N}}}
\end{array}
\]

\section{Examples}

\paragraph{Invariant $\Pi$ Sets}

\newcommand\piinv[3]{\ensuremath{\textnormal{$\Pi$}^{\dsd{inv}}\,\tptmns{#1}{#2}.\,\dcd{#3}}}

\[
\begin{array}{l}
\infer{\wftpsf{\Delta}{\Gamma}{\piinv{x}{S}{T} := \picl{y}{S}{\promote{}{y}{x.T}}}}
      {\wftpsf{\Delta}{\cdot}{S} &
       \wftpsf{\Delta,\tptm{x}{S}}{\Gamma}{T}}
\\ \\
\infer{\oftpsf{\Delta}{\Gamma}{\ulam{x}{M} := \ulam{y}{\promote{\promote{}{y}{x.T}}{y}{x.M}}}{\piinv{x}{S}{T}}}
      {\oftpsf{\Delta,\tptm{x}{S}}{\Gamma}{M}{T}}
\\ \\
\infer{\oftpsf{\Delta}{\Gamma}{\app{M}{N}}{\subst{T}{N}{x}}}
      {\oftpsf{\Delta}{\Gamma}{M}{\piinv{x}{S}{T}} &
        \oftpsf{\Delta}{\cdot}{N}{S}}
\\ \\
\app{\ulam{x}{M}}{N} \deq \subst{M}{N}{x} \\
M : \piinv{x}{S}{T} \deq \ulam{x}{\app{M}{x}} \\
\end{array}
\]
The $\eta$ needs the $\eta$ for promote, so without equality reflection
it would only hold propositionally.  

\paragraph{Composition}

Suppose $\wftpcc{\Delta}{\C}$, then we have 

\[
\begin{array}{rcl}
comp & : & \piinv{x}{\obtp{\C}}{\piinv{y}{\obtp{\C}}{\piinv{z}{\obtp{\C}}{}}}\\
     &   & {\piinv{p}{\Hom{\C}{\unob{x}}{\unob{y}}}{\piinv{q}{\Hom{\C}{\unob{y}}{\unob{z}}}{\Hom{\C}{\unob{x}}{\unob{z}}}}}
\end{array}
\]

\section{Intervals}

\[
\infer{\wfctxc{\Delta}{({\Gamma},\vdimtm{x}{v})}}
      {\wfctxc{\Delta}{\Gamma}}
\]

\[
({\Gamma},\vdimtm{x}{v})^\con := \Gamma^\con,\vdimtm{x}{\flip{v}}
\]

As a notational definition, we write 
\[
\begin{array}{rcl}
\vwfdimc{\Delta}{\Gamma}{r}{\co} & := & \wfdimc{\Delta}{\Gamma}{r} \\
\vwfdimc{\Delta}{\Gamma}{r}{\con} & := & \wfdimc{\Delta}{\Gamma^\con}{r} \\
\end{array}
\]
with the idea that a map into \op{\II} is equivalently a map from
$\op{\Gamma}$.

The main interval judgement on the right is \wfdim{\Gamma}{r}, which
represents a covariant element of $\II$ in $\Gamma$.
\[
\begin{array}{c}
\infer{\wfdimc{\Delta}{\Gamma}{0}}{} 
\qquad
\infer{\wfdimc{\Delta}{\Gamma}{1}}{} 
\qquad
\infer{\wfdimc{\Delta}{\Gamma}{x}}{\vdimtm{x}{\co} \in \Gamma} 
\qquad
\infer{\wfdimc{\Delta}{\Gamma}{\rev{r}}}
      {\vwfdimc{\Delta}{\Gamma}{r}{\con}}
\\ \\
\infer[\deriv]{\vwfdimc{\Delta}{\Gamma}{0}{\con}}{} 
\qquad
\infer[\deriv]{\vwfdimc{\Delta}{\Gamma}{1}{\con}}{} 
\qquad
\infer[\deriv]{\vwfdimc{\Delta}{\Gamma}{x}{\con}}{\vdimtm{x}{\con} \in \Gamma} 
\qquad
\infer[\deriv]{\vwfdimc{\Delta}{\Gamma}{\rev{r}}{\con}}{\wfdimc{\Delta}{\Gamma}{r}}
\\ \\
\rev{0} \deq 1 \\
\rev{1} \deq 0 \\
\rev{(\rev{r})} \deq r \\
\end{array}
\]
Note that \rev{r} represents the reversor map from \op{\II} to \II.
(\FIXME{add connections?})

When \wfdimc{\Delta}{\Gamma,\vdimtm{x}{v},\Gamma'}{r'} and
\vwfdimc{\Delta}{\Gamma,\Gamma'}{r}{v}, then we have
\wfdimc{\Delta}{\Gamma,\nsubst{\Gamma'}{r}{x}}{\nsubst{r'}{r}{x}} defined as
follows:
\[
\begin{array}{rcl}
\nsubst{0}{r}{x} & := & 0 \\ 
\nsubst{1}{r}{x} & := & 1 \\
\nsubst{x}{r}{x} & := & r \\
\nsubst{y}{r}{x} & := & y \\
\nsubst{(\rev{r})}{r'}{x} & := & \rev{\nsubst{r}{r'}{x}} \\ 
\end{array}
\]

\[
\infer[\textbf{admiss}]
      {\Gamma,\nsubst{\Gamma'}{r}{x} \vdash \nsubst{J}{r}{x}}
      {\Gamma,\vdimtm{x}{v},\Gamma' \vdash {J} &
        \vwfdimc{\Delta}{\Gamma}{r}{v}}
\]

\subsection{Directed Interval HIT}

\[
\begin{array}{c}
\infer{\wftpcc{\Delta}{\I}}
      {}
\qquad
\infer{\oftpc{\Delta}{\Gamma}{\Iz}{\I}}{}
\qquad
\infer{\oftpc{\Delta}{\Gamma}{\Io}{\I}}{}
\qquad
\infer{\oftpc{\Delta}{\Gamma}{\Iseg{r}}{\I}}{\wfdimc{\Delta}{\Gamma}{r}}
\\ \\
\Iseg{0} \deq \Iz \\
\Iseg{1} \deq \Io \\
\\
\infer{\voftpc{\Delta}{\Gamma}{\Ielim{x.A}{N_0}{N_1}{N}{M}}{u}{\subst{A}{M}{x}}}
      {\begin{array}{l}
          \wftpp{\Delta}{\Gamma,\vptptm{x}{\co}{\I}}{A} \\
          \oftpc{\Delta}{\Gamma}{M}{\I} \\
          \oftpp{\Delta}{\Gamma}{N_0}{\subst{A}{\Iz}{x}} \\
          \oftpp{\Delta}{\Gamma}{N_1}{\subst{A}{\Io}{x}} \\
          \oftpp{\Delta}{\Gamma,\vdimtm{y}{\co}}{N}{\subst{A}{\Iseg{y}}{x}}
        \end{array}
      }
\end{array}
\]

\FIXME{is contravariant elim derivable? or does it need to be primitive?}

\[
\begin{array}{rcll}
\Ielim{}{N_1}{N_2}{N}{\Iz} & \equiv & N_1 \\
\Ielim{}{N_1}{N_2}{N}{\Io} & \equiv & N_2 \\
\Ielim{}{N_1}{N_2}{N}{\Iseg{r}} & \equiv & \nsubst{N}{r}{y} \\
\end{array} \\
\]

\subsection{Hom Sets (Interval)}

\[
\begin{array}{c}
\infer{\wftpsf{\Delta}{\Gamma}{\HomO{\C}{M}{N}}}
      {\wftpcc{\Delta}{\C} &
        \oftpsf{\Delta}{\Gamma}{M}{\obtp \C} & 
        \oftpsf{\Delta}{\Gamma}{N}{\obtp \C} 
      }
\\ \\
\infer{\oftpsf{\Delta}{\Gamma}{\nlam{x}{M}}{\HomO{\C}{M_0}{M_1}}}
      {\begin{array}{lll}
          \wftpcc{\Delta}{\C} & 
          \oftpsf{\Delta}{\Gamma}{M_0}{\obtp{\C}} & 
          \oftpsf{\Delta}{\Gamma}{M_1}{\obtp{\C}} \\
          \oftpc{\Delta}{\Gamma,\vdimtm{x}{\co}}{M}{\C} &
          \nsubst{M}{0}{x} \deq \unob{M_0} & 
          \nsubst{M}{1}{x} \deq \unob{M_1} \\
       \end{array}
      }
\\ \\
\infer{\oftpsf{\Delta}{\Gamma}{\napp{M}{r}}{\C}}
      {\oftpc{\Delta}{\Gamma}{M}{\HomO{\C}{M_0}{M_1}} &
        \wfdimc{\Delta}{\Gamma}{r}
      }
\\ \\
\napp{M}{0} \deq \unob{M_0} \\ 
\napp{M}{1} \deq \unob{M_1} \\ 
\\ 
\napp{(\nlam{x}{M})}{r} \deq \nsubst{M}{r}{x} \\
M : \HomO{\C}{M_0}{M_1} \deq \nlam{x}{\napp{M}{x}}\\
\end{array}
\]


\section{Properties}

%% \begin{lem}
%% For all $v, \flip{\flip{v}}$ is $v$.
%% \end{lem}

%% \begin{lem}
%% For all $\Gamma$, ${\Gamma^\con}^\con$ is $\Gamma$.
%% \end{lem}

%% \begin{lem}
%% If \wfctx{\Gamma} then \wfctx{{\Gamma}^\con}.  
%% \end{lem}

%% \begin{lem}
%% If ${\ectx \Gamma x {v}{w}A d , \Gamma' \vdash J}$ and $\vvoftp \Gamma M {v}{w} A$
%% then $\Gamma,\subst M x {\ctx {\Gamma'}} \vdash \subst M x J$.  
%% \end{lem}

%% \begin{lem}
%% If $\vvoftp{\Gamma}{M}{\inv}{w}{A}{d}$ then
%%  $\vvoftp{\Gamma}{M}{v}{w}{A}$.
%% \end{lem}
%% FIXME $u$ or $v$?

%% \begin{lem}
%% If $\Gamma \vdash J$ then $\Gamma,\Gamma' \vdash J$.
%% \end{lem}

\section{Examples}

\subsection{Invariant $\Pi$ sets}

%% \subsection{\op{-} is an involution}

%% Suppose \wftpc{\Delta}{\Gamma^w}{A}.  

%% \[
%% \infer{\voftp{\Gamma,\vtptm{x}{\co}{w}{A}}{\optm{\optm{x}}}{w}{\optp{(\optp{A})}}}
%%       {\infer{\voftp{\Gamma^\con,\vtptm{x}{\con}{\flip{w}}{A}}{\optm{x}}{\flip{w}}{{\optp{A}}}}
%%              {{\voftp{\Gamma,\vtptm{x}{\co}{{w}}{A}}{x}{{w}}{{{A}}}}}}
%% \]

%% \[
%% \infer{\voftp{\Gamma,\vtptm{x}{\co}{w}{\optp{(\optp{A})}}}{\letop{}{x}{y.{\letop{}{y}{z.z}}}}{w}{A}}
%%       {{\vvoftp{\Gamma,\vtptm{x}{\co}{w}{\optp{(\optp{A})}}}{x}{\co}{w}{\optp{(\optp{A})}}} &
%%         \infer{\voftp{\Gamma,\vtptm{x}{\co}{w}{\optp{(\optp{A})}},\vtptm{y}{\con}{w}{\op{A}}}{\letop{}{y}{z.z}}{w}{A}}
%%               {\begin{array}{l}
%%                   \vvoftp{\Gamma,\vtptm{x}{\co}{w}{\optp{(\optp{A})}},\vtptm{y}{\con}{w}{\op{A}}}{y}{\con}{w}{\op{A}} \\
%%                   \vvoftp{\Gamma,\vtptm{x}{\co}{w}{\optp{(\optp{A})}},\vtptm{y}{\con}{w}{\op{A}},\vtptm{z}{\co}{w}{A}}{z}{\co}{w}{A}
%%                 \end{array}}
%%       }
%% \]

%% \[
%% {\Gamma,\vtptm{x}{\co}{w}{A}} \vdash {\letop{}{{\optm{\optm{x}}}}{y.{\letop{}{y}{z.z}}}} \deq x
%% \]

%% \FIXME{need some sort of identity type to do the other direction}

%% %% \[
%% %% {\Gamma,\vtptm{x}{\co}{w}{\op{(\op{A})}} \vdash {\letop{}{x}{y.{\letop{}{y}{z.z}}}} \deq x
%% %% \]

%% \subsection{Paths in \op{-}}

%% Suppose \wftpc{\Delta}{\Gamma^w}{A} and \voftp{\Gamma,\vdimtm{x}{\co}}{a}{w}{A}.

%% \[
%% \infer{\voftp{\Gamma,\vdimtm{x}{\co}}{\optm{?}}{w}{\op{A}}}
%%       {\voftp{{\Gamma}^\con,\vdimtm{x}{\con}}{?}{\flip{w}}{A}}
%% \]



%% \subsection{Core and Op}

%% \begin{enumerate}
%% \item $A$ and $\op{(\op{A})}$. Suppose \wftp{\Gamma^w}{A}.  

%% If \voftp{\Gamma}{M}{w}{A}, then we have
%% \[
%% \infer{\voftp{\Gamma}{\optm{\optm{M}}}{w}{\op{(\op{A})}}}
%%       {\infer{\voftp{\Gamma^\con}{\optm{M}}{\flip{w}}{\op{A}}}
%%              {\voftp{{\Gamma^\con}^\con}{M}{\flip{\flip{w}}}{A}}}
%% \]
%% using ${{\Gamma^\con}^\con} = \Gamma$ 
%% and ${\flip{\flip{w}}} = w$.  

%% If \voftp{\Gamma}{M}{w}{\op{(\op{A})}} then we have 
%% \[
%% \infer{\voftp{\Gamma}{\letop{}{\co}{x.M}{\letop{}{\con}{x}{y.y}}}{w}{A}}
%%       {{\voftp{\Gamma}{M}{w}{\op{(\op{A})}}} &
%%         \infer{\voftp{\ectx{\Gamma}{x}{\con}{w}{\op{A}}}{\letop{}{\con}{x}{y.y}}{w}{A}}
%%               {\infer{\vvoftp{\ectx{\Gamma}{x}{\co}{w}{\op{A}}}{x}{\con}{w}{\op{A}}}
%%                      {\infer{\voftp{\ectx{\Gamma^\con}{x}{\co}{\flip{w}}{\op{A}}}{x}{\flip{w}}{\op{A}}}{}} &
%%                \infer{\voftp{\ectx{\ectx{\Gamma}{x}{\con}{w}{\op{A}}}{y}{\co}{w}{A}}{y}{w}{A}}
%%                      {}
%%               }}
%% \]

%% \item \Core{(\Core{A})} and \Core{A}.  Suppose \wftp{\Gamma^w}{A}.  

%% If \voftp{\Gamma}{M}{w}{\Core{A}}, then 
%% \[
%% \infer{\voftp{\Gamma}{?}{w}{\Core{A}}}
%%       {\voftp{\Gamma}{M}{w}{\Core{A}} &
%%         \voftp{\ectx{\Gamma}{x}{\inv}{w}{A}}{?}{w}{\Core{(\Core{A})}}
%%       }
%% \]

%% \end{enumerate}

%% \paragraph{Symmetry}

%% Suppose \wftp{\Gamma}{A}.
%% The following context is well-formed (for any $d$):
%% \[
%% \Gamma_0 := \coctx {\coctx {\coctx \Gamma x A \backd} y A \ford} p {\Hom{\wtp{A}{\ford}}{x}{y}} d
%% \]
%% However, the judgement 
%% \[
%% \wftp{\Gamma_0}{\Hom{\wtp{A}{\ford}} y x}
%% \]
%% is not derivable, because to show this, we would need that
%% $\wftp{\Gamma_0}{A}$ (which is true, by weakening) and 
%% \oftp{\Gamma_0}{y}{A}{\backd} 
%% and 
%% \oftp{\Gamma_0}{x}{A}{\ford}.  These are not derivable, 
%% it would require, e.g. $\wtptm{y}{d}{A} \in \Gamma_0$ for $d \le \backd$,
%% but we have $\wtptm{y}{\ford}{A} \in \Gamma_0$, and $\ford \not \le
%% \backd$.  

%% Dually, in 
%% \[
%% \Gamma_1 := \coctx {\coctx {\coctx \Gamma x A \ford} y A \backd} p {\Hom{\wtp{A}{\backd}}{x}{y}} d
%% \]
%% it is not the case that $\wftp{\Gamma_1}{\Hom{\wtp{A}{\backd}}{y}{x}}$.  

%% However, in 
%% \[
%% \Gamma_3 := \coctx {\coctx {\coctx \Gamma x A \symd} y A \symd} p {\Hom{\wtp{A}{\symd}}{x}{y}} d
%% \]
%% we have \wftp{\Gamma_3}{\Hom{\wtp{A}{\symd}}{y}{x}} because
%% \wftp{\Gamma_3}{A} (by weakening) 
%% and \woftp{\Gamma_3}{y}{A}{\invd{\symd}}
%% and \woftp{\Gamma_3}{x}{A}{\symd}.  Thus, we can apply $\dsd{J}$, and to
%% derive
%% \[
%% \woftp{\Gamma_3}{\jay{\Gamma_3.{\Hom{\wtp{A}{\symd}}{y}{x}}}{?}{p}}{\Hom{\wtp{A}{\symd}}{y}{x}}{d}
%% \]
%% it suffices to derive
%% \[
%% \oftp{\coctx \Gamma x A \symd}{\refl{x}}{\Hom{\wtp{A}{\symd}}{x}{x}}
%% \]
%% which is true.  

%% Thus, symmetry is not statable when $A$ is considered with direction
%% \ford\/ or \backd, but true when considered at direction \symd.  

%% \paragraph{Groupoid Structure}

%% Assume \wftp{\Gamma}{A}.

%% The following context is well-formed (for any $d_1,d_2$):

%% \[
%% \Gamma_0 := \coctx {\coctx {\coctx {\coctx {\coctx \Gamma x A \backd} y A \symd} z A \ford} p {\Hom{\wtp{A}{\ford}}{x}{y}} {d_1}} q {\Hom{\wtp{A}{\ford}}{y}{z}} {d_2}
%% \]
%% Note that $y$ must be symmetric, because it occurs on both sides of an equation.  

%% \wftp{\Gamma_0}{\Hom{\wtp{A}{\ford}}{x}{z}} because 
%% \woftp{\Gamma_0}{x}{A}{\backd} and 
%% \woftp{\Gamma_0}{z}{A}{\ford}.

%% \paragraph{Tethering}

%% The elimination rule for \dsd{bool} is ``untethered'': the direction of
%% the boolean being analyzed is unrelated to the direction of the 
%% result.  This allows you to define, for example,

%% \[
%% \woftp{\coctx \cdot x {\dsd{2}} \ford}{\ite{\_.\dsd{2}}{\dsd{true}}{\dsd{false}}{x}}{\dsd{2}}{\backd}
%% \]
%% which casts a forward boolean to a backwards one.  The opposite is also
%% definable, and (conjecture) these should give an equivalence between
%% \dsd{2} and \op{\dsd{2}} (use bool-elim to prove that they compose to
%% the identity).  

%% Similarly, the elimination rule for $\Sigma$ is untethered; for example,
%% for \wftp{\Gamma}{A},
%% \[
%% \woftp{\coctx \Gamma p {\wsigma x \ford A B}
%%   \ford}{\splitsig{\_.\wsigma{x}{\backd}{A}{B}}{x,y.(\optm x, \optm y)}{p}}{\wsigma x \backd
%%   {\op A} {\op B}}{\backd}
%% \]
%% So we get a (covariant) map from $\wsigma x \ford A B$ to $\op{(\wsigma
%%   x \backd {\op A} {\op B})}$, which (conjecture) should be an
%% equivalence.    

%% \paragraph{Transport}

%% \paragraph{Ap}

%% \paragraph{Properties of Op}

%% \paragraph{Swapping directions}

%% \subsection{Exact Equalities}

%% Add new world $\dsd{exact} \le \symd$.  Variations:
%% \begin{itemize}
%% \item no extra axioms: usual computational interp with $J$ just
%%   computing on \refls\/ should work if you only ever use exact equalities.

%% \item extensional: add equality reflection for 
%% \Hom{A^\dsd{exact}}{M}{N}.

%% \item OTT-style: add funext and
%% propositional univalence?  
%% \end{itemize}
%% In all of these, hopefully \Hom{A^\dsd{exact}}{M}{N} and any transports
%% on it are erasable at run-time.  

%% \subsection{Open Issues}

%% \begin{enumerate}
%% \item Check that the typing makes sense for the defeq rules; should
%%   both terms have the same direction $d$?

%% \item \wftp{\op \Gamma}{A} for $\Pi$ and \wftp{\Gamma}{A} for \dsd{Hom}
%%   are necessary, right?

%% \item Do you need the labels on $\Pi$ and $\Sigma$?  Or can types be
%%   more modal, with the direction being passed in from the outside?  

%%   Problem: need to write \wtptm{x}{d}{A} and \wtptm{x}{\invd d}{A} for
%%   the same $A$, so you don't want $d$ to need to be something specific.

%% \item Would coprodcuts/lists be for a labelled type, or would you flow
%%   the direction in from outside?

%% \item What do the directions on
%% \wtptm{p}{d}{\Hom{\wtp{A}{\ford}}{M}{N}} mean?
%% E.g. the ? in $\Ielimfor{}{}{}{}{}$.

%% \item Should $d_1$ and $d_2$ in J be the same?

%% \end{enumerate}

\section{Related Work}

\subsection{Warren's Directed Type Theory}

\begin{verbatim}
x',x,y,y',u: \Hom{x'}{x}, v:\Hom{x}{y}, w: \Hom{y}{y'}, Delta |- E
x,y,u,Delta |- E[x/x',y/y',refl/u,refl/v]
------------------------------------------
x',x,y,y',u: \Hom{x'}{x}, v:\Hom{x}{y}, w: \Hom{y}{y'}, Delta |- J(...) : E

If z\in{x',x,y,y'} occurs in Delta, then it occurs in E
x and y occur in E[x/x',y/y',refl/u,refl/v]

E.g. 

x',x,y,y',u,v,w |- Hom(y,x) -- y and x don't get contracted
x',x,y,y',u,v,w |- Hom(x,x') -- doesn't mention y

x',x,y,y',u,v,w |- Hom(x,x') * Hom(x,y) -- need to extend the side conditions for pairs...
\end{verbatim}


%% \setlength{\bibsep}{-1pt} %% dirty trick: make this negative
{ %% \small
%% \linespread{0.70}
\bibliographystyle{abbrvnat}
\bibliography{drl-common/cs}
}


\end{document}
